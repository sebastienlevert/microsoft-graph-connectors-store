{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "runPowerShellInline",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell", // or "AzureCLI"
      /*"identity": {
        "type": "userAssigned",
        "userAssignedIdentities": {
          "/subscriptions/01234567-89AB-CDEF-0123-456789ABCDEF/resourceGroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID": {}
        }
      },*/
      "properties": {
        "forceUpdateTag": "1",
        
        "azPowerShellVersion": "3.0",  // or "azCliVersion": "2.0.80",
        "arguments": "-name \\\"John Dole\\\"",
        "environmentVariables": [
          {
            "name": "UserName",
            "value": "jdole"
          },
          {
            "name": "Password",
            "secureValue": "jDolePassword"
          }
        ],
        "scriptContent": "
          $endpoint = 'https://localhost:8081/'
          $MasterKey = 'C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=='

          $KeyType = 'master'
          $TokenVersion = '1.0'
          $date = Get-Date
          $utcDate = $date.ToUniversalTime()
          $xDate = $utcDate.ToString('r', [System.Globalization.CultureInfo]::InvariantCulture)
          $databaseId = 'mgcstorebrd42po'
          $containerId = 'mgccontainer'
          $itemId = 'TestItem'
          $itemResourceType = 'docs'
          $itemResourceId = 'dbs/'+$databaseId+'/colls/'+$containerId
          $itemResourceLink = 'dbs/'+$databaseId+'/colls/'+$containerId+'/docs'
          $verbMethod = 'POST'
          $requestUri = \"$endpoint$itemResourceLink\"

          $authKey = Generate-MasterKeyAuthorizationSignature -Verb $verbMethod -ResourceId $itemResourceId -ResourceType $itemResourceType -Date $xDate -MasterKey $MasterKey -KeyType $KeyType -TokenVersion $TokenVersion

          $header = @{
                  \"authorization\"         = \"$authKey\";
                  \"x-ms-version\"          = \"2018-12-31\";
                  \"Cache-Control\"         = \"no-cache\";
                  \"x-ms-date\"             = \"$xDate\";
                  \"Accept\"                = \"application/json\";
                  \"User-Agent\"            = \"PowerShell-RestApi-Samples\";
                  \"x-ms-documentdb-partitionkey\" = '[\"testPk\"]'
              }

          $ItemDefinition = @\"
          {
              \"id\": \"$itemId\",
            \"testProperty\": \"test\",
            \"pk\": \"testPk\"
          }
          \"@

          try {
              $result = Invoke-RestMethod -Uri $requestUri -Headers $header -Method $verbMethod -ContentType \"application/json\" -Body $ItemDefinition
              Write-Host \"create item response = \"$result
              return \"CreateItemSuccess\";
          }
          catch {
              # Dig into the exception to get the Response details.
              # Note that value__ is not a typo.
              Write-Host \"StatusCode:\" $_.Exception.Response.StatusCode.value__ 
              Write-Host \"Exception Message:\" $_.Exception.Message
            echo $_.Exception|format-list -force
          }
        ",
        "supportingScriptUris":[],
        "timeout": "PT30M",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D"
      }
    }
  ]
}
